<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #10b981;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .warning {
            color: #f59e0b;
            font-weight: bold;
        }
        .info {
            color: #3b82f6;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Service Worker Diagnostic Test</h1>
    
    <div class="test-section">
        <h2>üåê Navegador y Protocolo</h2>
        <div id="browser-info"></div>
        <div id="protocol-info"></div>
        <div id="host-info"></div>
    </div>

    <div class="test-section">
        <h2>üìã Verificaci√≥n de Requisitos</h2>
        <div id="requirements-check"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Service Worker Test</h2>
        <button onclick="testServiceWorkerManual()">Probar Registro Manual</button>
        <button onclick="checkSWFile()">Verificar Archivo SW</button>
        <button onclick="clearSWCache()">Limpiar Cache SW</button>
        <div id="sw-test-results"></div>
    </div>

    <div class="test-section">
        <h2>üìÑ Manifest Test</h2>
        <button onclick="testManifest()">Probar Manifest</button>
        <div id="manifest-results"></div>
    </div>

    <div class="test-section">
        <h2>üìù Log de Eventos</h2>
        <div id="event-log" class="log"></div>
    </div>

    <script>
        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // Check browser and protocol info
        function checkBrowserInfo() {
            const browserInfo = document.getElementById('browser-info');
            const protocolInfo = document.getElementById('protocol-info');
            const hostInfo = document.getElementById('host-info');

            // Browser info
            const userAgent = navigator.userAgent;
            const isChrome = /Chrome/.test(userAgent) && /Google Inc/.test(navigator.vendor);
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            browserInfo.innerHTML = `
                <p class="${isChrome ? 'success' : 'warning'}">
                    üß≠ Navegador: ${isChrome ? 'Chrome ‚úÖ' : 'Otro navegador ‚ö†Ô∏è'}
                </p>
                <p>User Agent: ${userAgent}</p>
            `;

            // Protocol info
            const protocol = window.location.protocol;
            const isHttps = protocol === 'https:';
            const isHttp = protocol === 'http:';
            
            protocolInfo.innerHTML = `
                <p class="${isLocalhost ? 'success' : (isHttps ? 'success' : 'error')}">
                    üîí Protocolo: ${protocol} ${isLocalhost ? '(localhost - OK) ‚úÖ' : (isHttps ? '(HTTPS) ‚úÖ' : '(HTTP) ‚ö†Ô∏è')}
                </p>
            `;

            // Host info
            hostInfo.innerHTML = `
                <p class="${isLocalhost ? 'success' : 'info'}">
                    üè† Host: ${window.location.hostname} ${isLocalhost ? '(entorno local) ‚úÖ' : '(entorno remoto)'}
                </p>
                <p>üìç URL completa: ${window.location.href}</p>
            `;

            log(`Informaci√≥n del navegador detectada: ${userAgent}`);
            log(`Protocolo: ${protocol}, Host: ${window.location.hostname}`);
        }

        // Check PWA requirements
        function checkRequirements() {
            const requirementsDiv = document.getElementById('requirements-check');
            let html = '';

            // Check Service Worker support
            const swSupported = 'serviceWorker' in navigator;
            html += `<p class="${swSupported ? 'success' : 'error'}">Service Worker: ${swSupported ? 'Soportado ‚úÖ' : 'No soportado ‚ùå'}</p>`;
            if (!swSupported) {
                log('‚ùå Service Workers no soportados en este navegador', 'error');
            }

            // Check HTTPS (or localhost)
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isHttps = window.location.protocol === 'https:';
            const secureContext = isLocalhost || isHttps;
            html += `<p class="${secureContext ? 'success' : 'error'}">Contexto Seguro: ${secureContext ? 'S√≠ ‚úÖ' : 'No ‚ùå'}</p>`;
            if (!secureContext) {
                log('‚ùå Se requiere HTTPS o localhost para Service Workers', 'error');
            }

            // Check IndexedDB
            const idbSupported = 'indexedDB' in window;
            html += `<p class="${idbSupported ? 'success' : 'warning'}">IndexedDB: ${idbSupported ? 'Soportado ‚úÖ' : 'No soportado ‚ö†Ô∏è'}</p>`;

            // Check Cache API
            const cacheSupported = 'caches' in window;
            html += `<p class="${cacheSupported ? 'success' : 'warning'}">Cache API: ${cacheSupported ? 'Soportado ‚úÖ' : 'No soportado ‚ö†Ô∏è'}</p>`;

            // Check Web App Manifest
            const manifestSupported = 'BeforeInstallPromptEvent' in window || 'onbeforeinstallprompt' in window;
            html += `<p class="${manifestSupported ? 'success' : 'info'}">Web App Manifest: ${manifestSupported ? 'Soportado ‚úÖ' : 'Estado desconocido ‚ÑπÔ∏è'}</p>`;

            requirementsDiv.innerHTML = html;
        }

        // Test Service Worker registration
        async function testServiceWorkerManual() {
            const resultsDiv = document.getElementById('sw-test-results');
            resultsDiv.innerHTML = '<p class="info">üîÑ Procesando registro de Service Worker...</p>';

            if (!('serviceWorker' in navigator)) {
                resultsDiv.innerHTML = '<p class="error">‚ùå Service Workers no soportados</p>';
                log('Service Worker no soportado', 'error');
                return;
            }

            try {
                log('üîÑ Intentando registrar Service Worker...', 'info');
                
                // Unregister any existing service workers first
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    log(`üóëÔ∏è Eliminando registro existente: ${registration.scope}`, 'warning');
                    await registration.unregister();
                }

                // Try to register with detailed error handling
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/',
                    updateViaCache: 'none'
                });

                log(`‚úÖ Service Worker registrado exitosamente: ${registration.scope}`, 'success');
                
                // Wait for the service worker to be ready
                await navigator.serviceWorker.ready;
                log('‚úÖ Service Worker est√° listo y activo', 'success');

                // Check if it's controlling the page
                if (navigator.serviceWorker.controller) {
                    log('üéØ Service Worker est√° controlando la p√°gina actual', 'success');
                } else {
                    log('‚ö†Ô∏è Service Worker est√° registrado pero no controlando la p√°gina actual', 'warning');
                }

                resultsDiv.innerHTML = `
                    <p class="success">‚úÖ Service Worker registrado exitosamente</p>
                    <p class="info">Scope: ${registration.scope}</p>
                    <p class="info">Estado: ${registration.active ? 'Activo' : 'Inactivo'}</p>
                    <p class="${navigator.serviceWorker.controller ? 'success' : 'warning'}">
                        ${navigator.serviceWorker.controller ? 'üéØ Controlando p√°gina' : '‚ö†Ô∏è No controlando p√°gina'}
                    </p>
                `;

            } catch (error) {
                log(`‚ùå Error detallado: ${error.message}`, 'error');
                log(`Tipo de error: ${error.name}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                
                resultsDiv.innerHTML = `
                    <p class="error">‚ùå Error al registrar Service Worker</p>
                    <p class="error">Mensaje: ${error.message}</p>
                    <p class="error">Tipo: ${error.name}</p>
                    <p class="info">URL intentada: ${window.location.origin}/sw.js</p>
                `;
            }
        }

        // Check if SW file exists
        async function checkSWFile() {
            const resultsDiv = document.getElementById('sw-test-results');
            resultsDiv.innerHTML = '<p class="info">üîç Verificando archivo Service Worker...</p>';

            try {
                const response = await fetch('/sw.js', {
                    method: 'GET',
                    cache: 'no-cache'
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    const contentLength = response.headers.get('content-length');
                    log(`‚úÖ Archivo SW encontrado (${response.status})`, 'success');
                    log(`üìÑ Tipo: ${contentType}, Tama√±o: ${contentLength} bytes`, 'info');
                    
                    // Get first few lines to verify it's JavaScript
                    const text = await response.text();
                    const firstLines = text.split('\n').slice(0, 5).join('\n');
                    log(`üìù Primeras l√≠neas:\n${firstLines}`, 'info');

                    resultsDiv.innerHTML = `
                        <p class="success">‚úÖ Archivo Service Worker accesible</p>
                        <p class="info">Status: ${response.status}</p>
                        <p class="info">Content-Type: ${contentType}</p>
                        <p class="info">Tama√±o: ${contentLength} bytes</p>
                        <p class="info">Primeras l√≠neas v√°lidas: ${firstLines.includes('const') || firstLines.includes('function') ? 'S√≠ ‚úÖ' : 'No ‚ùå'}</p>
                    `;
                } else {
                    log(`‚ùå Archivo SW no accesible (${response.status})`, 'error');
                    resultsDiv.innerHTML = `<p class="error">‚ùå Archivo no accesible: ${response.status}</p>`;
                }
            } catch (error) {
                log(`‚ùå Error al verificar archivo: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<p class="error">‚ùå Error de red: ${error.message}</p>`;
            }
        }

        // Clear SW cache
        async function clearSWCache() {
            const resultsDiv = document.getElementById('sw-test-results');
            resultsDiv.innerHTML = '<p class="info">üßπ Limpiando cach√© de Service Worker...</p>';

            try {
                // Clear service worker cache
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`üìã Caches encontradas: ${cacheNames.join(', ')}`, 'info');
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`üóëÔ∏è Cache eliminada: ${cacheName}`, 'warning');
                    }
                }

                // Unregister service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        log(`üóëÔ∏è Service Worker desregistrado: ${registration.scope}`, 'warning');
                    }
                }

                log('‚úÖ Cach√© y Service Workers limpiados', 'success');
                resultsDiv.innerHTML = '<p class="success">‚úÖ Cach√© limpiada exitosamente</p>';
                
                // Reload page
                setTimeout(() => {
                    log('üîÑ Recargando p√°gina...', 'info');
                    location.reload();
                }, 1000);

            } catch (error) {
                log(`‚ùå Error limpiando cach√©: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Test manifest
        async function testManifest() {
            const resultsDiv = document.getElementById('manifest-results');
            resultsDiv.innerHTML = '<p class="info">üîç Verificando manifest...</p>';

            try {
                const response = await fetch('/manifest.json', {
                    method: 'GET',
                    cache: 'no-cache'
                });

                if (response.ok) {
                    const manifest = await response.json();
                    log('‚úÖ Manifest cargado exitosamente', 'success');
                    log(`üìã Nombre: ${manifest.name}`, 'info');
                    log(`üì± Nombre corto: ${manifest.short_name}`, 'info');
                    log(`üéØ Start URL: ${manifest.start_url}`, 'info');
                    log(`üì¶ Icons: ${manifest.icons?.length || 0} encontrados`, 'info');

                    resultsDiv.innerHTML = `
                        <p class="success">‚úÖ Manifest accesible y v√°lido</p>
                        <p class="info">Nombre: ${manifest.name}</p>
                        <p class="info">Start URL: ${manifest.start_url}</p>
                        <p class="info">Display: ${manifest.display}</p>
                        <p class="info">Icons: ${manifest.icons?.length || 0}</p>
                    `;
                } else {
                    log(`‚ùå Manifest no accesible (${response.status})`, 'error');
                    resultsDiv.innerHTML = `<p class="error">‚ùå Manifest error: ${response.status}</p>`;
                }
            } catch (error) {
                log(`‚ùå Error manifest: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('üöÄ P√°gina cargada, iniciando diagn√≥stico...', 'info');
            checkBrowserInfo();
            checkRequirements();
            
            // Check current SW status
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    log(`üìä Service Workers registrados actualmente: ${registrations.length}`, 'info');
                    registrations.forEach(reg => {
                        log(`üìç SW encontrado: ${reg.scope} (${reg.active ? 'activo' : 'inactivo'})`, 'info');
                    });
                });
            }
        });

        // Log any SW related errors
        window.addEventListener('error', (event) => {
            if (event.message?.includes('ServiceWorker') || event.message?.includes('sw.js')) {
                log(`‚ùå Error SW detectado: ${event.message}`, 'error');
            }
        });
    </script>
</body>
</html>